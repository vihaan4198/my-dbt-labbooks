<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dbt Error Handling: Hands-On Lab Guide</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Source+Sans+Pro:wght@400;600;700&display=swap');

        /* --- CSS Variables --- */
        :root {
            --bg-color: #f4f4f9;
            --main-text: #2c3e50;
            --primary-purple: #8e44ad;
            --primary-blue: #3498db;
            --error-red: #c0392b;
            --panel-bg: #ffffff;
            --header-border: #9b59b6;
            --code-bg-light: #f4f2f8;
            --code-text-dark: #3b3b3b;
            --success-color: #27ae60;
        }

        /* --- General Layout & Typography --- */
        body {
            font-family: 'Source Sans Pro', sans-serif;
            line-height: 1.6;
            color: var(--main-text);
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main.container {
            max-width: 1200px;
            width: 100%;
            margin: 20px auto;
            padding: 20px;
            background-color: var(--panel-bg);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 10px;
            flex-grow: 1;
        }
        h1, h2, h3, h4 {
            font-family: 'Source Sans Pro', sans-serif;
            font-weight: 700;
            color: var(--primary-purple);
        }
        h1 { font-size: 2.5em; text-align: center; border-bottom: 3px solid var(--header-border); padding-bottom: 10px; }
        h2 { font-size: 2em; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-top: 40px; }
        h3 { font-size: 1.5em; }
        p, li { font-size: 1.1em; }
        ul { padding-left: 20px; }
        pre {
            font-family: 'Roboto Mono', monospace;
            background-color: var(--code-bg-light);
            color: var(--code-text-dark);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 0.9em;
            white-space: pre;
            overflow-x: auto;
        }
        code {
            background-color: #e8e6ed;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9em;
        }

        /* --- Header & Footer --- */
        .page-header, .page-footer {
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-blue));
            color: white;
            padding: 15px 30px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .page-header h1 { margin: 0; font-size: 1.8em; color: white; border: none; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .page-footer { font-size: 1em; display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap; }
        .page-footer a { color: white; text-decoration: none; font-weight: 600; }
        .page-footer a:hover { text-decoration: underline; }
        .footer-item { display: flex; align-items: center; gap: 8px; }

        /* --- Tab Navigation --- */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-link { padding: 10px 15px; cursor: pointer; border: none; background: none; font-size: 1.1em; font-weight: 600; color: #95a5a6; transition: color 0.3s ease; }
        .tab-link:hover { color: var(--primary-purple); }
        .tab-link.active { color: var(--primary-purple); border-bottom: 3px solid var(--primary-purple); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- Content Sections (Blog/Tutorial Style) --- */
        .content-section {
            background: #fdfcfe;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0d4e4;
        }
        .step {
            position: relative;
            padding-left: 60px;
            margin-bottom: 50px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #ccc;
        }
        .step:last-child { border-bottom: none; margin-bottom: 0; }
        .step::before {
            content: counter(step-counter);
            counter-increment: step-counter;
            position: absolute; left: 0; top: -5px; width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-blue));
            color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.2em; font-weight: bold;
        }
        .content-section { counter-reset: step-counter; }
        .step h3 { font-size: 1.6em; color: var(--primary-purple); margin-top: 0; border: none; }
        .step p, .step ul, .step ol { font-size: 1.1em; color: #555; }
        
        /* --- Error Demo Components --- */
        .error-demo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .error-demo-panel {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .error-demo-panel h4 {
            margin: 0;
            padding: 10px 15px;
            background-color: #f9f9f9;
        }
        .error-demo-panel pre {
            border-radius: 0 0 8px 8px;
            margin: 0;
            border: none;
            max-height: 250px;
            overflow-y: auto;
        }
        .console-error {
            color: #ffb8b8;
            background-color: #4d1818;
        }
        .info-box {
            background-color: #eaf7f7;
            border-left: 5px solid var(--primary-blue);
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        /* --- Quiz Components --- */
        .quiz-section { background: #fdfcfe; padding: 20px; border-radius: 8px; border: 1px solid #e0d4e4; }
        .question { margin-bottom: 20px; }
        .options label { display: block; margin: 5px 0; cursor: pointer; padding: 10px; border-radius: 5px; }
        .options label:hover { background-color: #e5e0f9; }
        .feedback { font-weight: bold; margin-left: 10px; }
        .correct { color: var(--success-color); }
        .incorrect { color: var(--error-red); }

        @media (max-width: 800px) {
            .error-demo { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header class="page-header">
    <h1> Learn with Vikash: dbt Error Handling Lab</h1>
</header>

<main class="container">
    <h1>Lab Guide: Mastering dbt Errors</h1>

    <div class="tabs">
        <button class="tab-link active" data-tab="setup">Lab Setup & Concepts</button>
        <button class="tab-link" data-tab="scenarios">Error Scenarios</button>
        <button class="tab-link" data-tab="practices">Best Practices</button>
        <button class="tab-link" data-tab="quiz">Quiz</button>
    </div>
    
    <div id="setup" class="tab-content active"></div>
    <div id="scenarios" class="tab-content"></div>
    <div id="practices" class="tab-content"></div>
    <div id="quiz" class="tab-content"></div>

</main>

<footer class="page-footer">
    <div class="footer-item"><strong>Vedadots</strong> - Expert in training services on tech stacks for Data, Cloud & AI</div>
    <div class="footer-item">üìß <a href="mailto:info@vedadots.com">Contact - info@vedadots.com</a></div>
</footer>

<script>
document.addEventListener("DOMContentLoaded", function() {

    // --- 1. DOM ELEMENT REFERENCES ---
    const DOM = {
        tabs: document.querySelectorAll('.tab-link'),
        tabContents: document.querySelectorAll('.tab-content'),
    };

    // --- 2. CONTENT ---
    const CONTENT = {
        setup: `
            <h2>Lab Setup: Creating Source Data</h2>
            <p>First, let's set up the raw data in your data warehouse. This will be the source for all our dbt models. Execute the following DDL and DML statements.</p>
            
            <h3>Data Definition Language (DDL)</h3>
            <pre><code>CREATE TABLE raw_customers (
    customer_id INTEGER,
    first_name VARCHAR(50),
    last_name VARCHAR(50)
);

CREATE TABLE raw_orders (
    order_id INTEGER,
    customer_id INTEGER,
    order_date DATE,
    status VARCHAR(20)
);</code></pre>

            <h3>Data Manipulation Language (DML)</h3>
            <pre><code>INSERT INTO raw_customers (customer_id, first_name, last_name) VALUES
(1, 'Michael', 'Scott'),
(2, 'Dwight', 'Schrute'),
(3, 'Jim', 'Halpert');

INSERT INTO raw_orders (order_id, customer_id, order_date, status) VALUES
(101, 1, '2025-01-15', 'completed'),
(102, 2, '2025-01-17', 'shipped'),
(103, 1, '2025-02-01', 'completed'),
(104, 3, '2025-02-03', 'shipped'),
(105, 2, '2025-02-05', 'returned');</code></pre>

            <h3>dbt sources.yml Setup</h3>
            <p>Now, create a file at <code>models/staging/schema.yml</code> to declare these tables as sources in your dbt project.</p>
            <pre><code>version: 2

sources:
  - name: jaffle_shop
    schema: public # Or your raw data schema
    tables:
      - name: raw_customers
      - name: raw_orders</code></pre>
            
            <h2>The Four-Step Debugging Process </h2>
            <div class="content-section">
                <div class="step">
                    <h3>Read the Error Message</h3>
                    <p>This is the most crucial step. Read the <strong>entire</strong> error message from top to bottom. dbt provides rich context, including the error type, the problematic file, and often the exact line number.</p>
                </div>
                <div class="step">
                    <h3>Inspect the File</h3>
                    <p>Open the file mentioned in the error message. Navigate to the line number if provided. Look for typos, incorrect syntax, or logical flaws in that specific area.</p>
                </div>
                <div class="step">
                    <h3>Isolate the Problem</h3>
                    <p>If the issue isn't obvious, try to isolate it. Comment out sections of your code or run just the <code>SELECT</code> statement from your model directly in your warehouse's UI.</p>
                </div>
                <div class="step">
                    <h3>Validate the Artifacts</h3>
                    <p>dbt creates helpful files in the <code>target/</code> directory. The compiled code in <code>target/compiled</code> is the "source of truth" for what dbt is attempting to execute.</p>
                </div>
            </div>
        `,
        scenarios: `
            <h2>Types of dbt Errors & Scenarios</h2>
            <p>Errors in dbt can occur at different stages. This section provides hands-on scenarios for each type.</p>
            
            <div class="info-box">
                <h4>Error Stages:</h4>
                <ol>
                    <li><strong>Initialization Error:</strong> dbt CLI cannot start.</li>
                    <li><strong>Parsing Error:</strong> dbt cannot understand a file's content (bad YAML or Jinja).</li>
                    <li><strong>Graph Validation Error:</strong> dbt finds a logical problem in the project's structure (e.g., a circular dependency).</li>
                    <li><strong>SQL Execution (Database) Error:</strong> The database rejects a validly compiled SQL query.</li>
                </ol>
            </div>

            <h2>Lab Scenario: Runtime Error</h2>
            <div class="content-section">
                <div class="step">
                    <h3>Scenario: Running dbt Outside a Project</h3>
                    <p>This error happens when you try to run dbt from a directory that isn't a dbt project.</p>
                    <div class="error-demo">
                        <div class="error-demo-panel">
                            <h4>Action & Command</h4>
                            <p>1. Navigate outside your dbt project: <code>cd ~</code></p>
                            <p>2. Run any command: <code>dbt run</code></p>
                        </div>
                        <div class="error-demo-panel">
                            <h4>Expected Error</h4>
                            <pre class="console-error"><code>dbt:  Not a dbt project. Missing dbt_project.yml.
        A dbt project is defined by the presence of a dbt_project.yml file.</code></pre>
                        </div>
                    </div>
                    <h4>Fix</h4>
                    <p>The solution is to navigate back to the root of your dbt project directory (<code>cd path/to/your/project</code>) and re-run the command.</p>
                </div>
            </div>

            <h2>Lab Scenario: Compilation Error</h2>
            <div class="content-section">
                <div class="step">
                    <h3>Scenario: Malformed Jinja</h3>
                    <p>This happens when dbt fails to parse Jinja syntax.</p>
                    <div class="error-demo">
                        <div class="error-demo-panel">
                            <h4>Problematic Code (stg_customers.sql)</h4>
                            <pre><code>SELECT
    customer_id,
    first_name,
    last_name
FROM {{ source('jaffle_shop', 'raw_customers' }} -- Missing )</code></pre>
                        </div>
                        <div class="error-demo-panel">
                            <h4>Expected Error</h4>
                            <pre class="console-error"><code>Compilation Error in model stg_customers
  Got an unexpected token: 'name'. Expected 'rparen'.</code></pre>
                        </div>
                    </div>
                    <h4>Fix</h4>
                    <p>Correct the syntax by adding the missing parenthesis: <code>{{ source('jaffle_shop', 'raw_customers') }}</code>. Then run <code>dbt compile</code> to validate.</p>
                </div>
            </div>
            
            <h2>Lab Scenario: Dependency Error</h2>
            <div class="content-section">
                <div class="step">
                    <h3>Scenario: Circular Dependency</h3>
                    <p>This occurs when dbt finds a logical impossibility in your model references, like a loop.</p>
                     <div class="error-demo">
                        <div class="error-demo-panel">
                            <h4>Problematic Code</h4>
                            <pre><code>-- models/marts/customers.sql
SELECT * FROM {{ ref('orders') }}

-- models/marts/orders.sql
SELECT * FROM {{ ref('customers') }}</code></pre>
                        </div>
                        <div class="error-demo-panel">
                            <h4>Expected Error</h4>
                            <pre class="console-error"><code>dbt found a circular dependency.
The dependency is:
customers -> orders -> customers</code></pre>
                        </div>
                    </div>
                    <h4>Fix</h4>
                    <p>Correct the logic in one of the models to reference the correct upstream model (e.g., a staging model). An <code>orders</code> model should almost never depend on a final <code>customers</code> model.</p>
                </div>
            </div>

            <h2>Lab Scenario: Database Error</h2>
            <div class="content-section">
                <div class="step">
                    <h3>Scenario: Column Does Not Exist</h3>
                    <p>This error bypasses dbt's checks and comes directly from your data warehouse.</p>
                    <div class="error-demo">
                        <div class="error-demo-panel">
                            <h4>Problematic Code (customers_with_error.sql)</h4>
                            <pre><code>SELECT
    customer_id,
    full_name -- This column does not exist!
FROM {{ ref('stg_customers') }}</code></pre>
                        </div>
                        <div class="error-demo-panel">
                            <h4>Expected Error (PostgreSQL)</h4>
                            <pre class="console-error"><code>Database Error in model customers_with_error
  column "full_name" does not exist
  LINE 2:     full_name</code></pre>
                        </div>
                    </div>
                    <h4>Fix</h4>
                    <p>Correct the SQL to create the <code>full_name</code> column or remove it. For example: <code>first_name || ' ' || last_name AS full_name</code>.</p>
                </div>
            </div>
        `,
        practices: `
            <h2>Best Practices & Common Scenarios</h2>
            <div class="content-section">
                <div class="step">
                    <h3>Best Practices</h3>
                    <ul>
                        <li><strong>Lint Your Code:</strong> Use a tool like SQLFluff to catch syntax errors before you run dbt.</li>
                        <li><strong>Compile, Don't Always Run:</strong> Use <code>dbt compile</code> frequently. It's fast and will catch all parsing and dependency errors without connecting to your database.</li>
                        <li><strong>Test Narrowly:</strong> When working on a model, use the <code>--select</code> flag to run only what you need (e.g., <code>dbt build --select my_new_model+</code>).</li>
                        <li><strong>Trust the <code>target/</code> Directory:</strong> When in doubt, the compiled code in the <code>target/</code> folder is the "source of truth" for what dbt is attempting to execute.</li>
                    </ul>
                </div>
                <div class="step">
                    <h3>Common Scenarios Developers Face</h3>
                    <ul>
                        <li><strong>Typo in a <code>ref</code>:</strong> <code>{{ ref('customer') }}</code> instead of <code>{{ ref('customers') }}</code>.</li>
                        <li><strong>Incorrect YAML Indentation:</strong> This is a very common source of parsing errors in <code>schema.yml</code> or <code>dbt_project.yml</code>.</li>
                        <li><strong>Database Permissions:</strong> A <code>permission denied</code> error means your dbt user doesn't have the required grants in the database to <code>CREATE</code> or <code>SELECT</code>.</li>
                        <li><strong>NULLs in Calculations:</strong> A <code>division by zero</code> error often happens when a column used as a denominator contains <code>NULL</code> or <code>0</code>. Use <code>NULLIF()</code> or <code>CASE</code> statements to prevent this.</li>
                    </ul>
                </div>
            </div>
        `,
        quiz: `
            <h2>Knowledge Check Quiz üìù</h2>
            <div class="quiz-section" id="quiz-container"></div>
        `,
    };

    const QUIZ_QUESTIONS = [
        { q: '1. You run dbt run and get a "circular dependency" error. What type of error is this?', a: 'c', o: { a: 'Database Error', b: 'Parsing Error', c: 'Graph Validation Error', d: 'Initialization Error' } },
        { q: '2. Which command is fastest for checking if your Jinja syntax is correct without connecting to the database?', a: 'd', o: { a: 'dbt run', b: 'dbt test', c: 'dbt seed', d: 'dbt compile' } },
        { q: '3. You see an error message: Database Error: relation "my_table" does not exist. This is most likely a...', a: 'b', o: { a: 'Jinja parsing error.', b: 'Database execution error.', c: 'YAML indentation error.' } },
        { q: '4. Where would you look to find the exact SQL query that was sent to the database during your last dbt run?', a: 'c', o: { a: 'The logs/dbt.log file.', b: 'The target/compiled directory.', c: 'The target/run directory.', d: 'The dbt_project.yml file.' } },
        { q: '5. What is the very first and most important step in debugging any dbt error?', a: 'c', o: { a: 'Check the target/ directory.', b: 'Ask a colleague for help.', c: 'Read the full error message carefully.', d: 'Re-run the command.' } },
    ];

    // --- 3. INITIALIZATION & RENDERING ---
    function init() {
        // Populate tabs
        for (const [key, value] of Object.entries(CONTENT)) {
            const tabContent = document.getElementById(key);
            if (tabContent) {
                tabContent.innerHTML = value;
            }
        }
        
        // Populate Quiz
        const quizContainer = document.getElementById('quiz-container');
        quizContainer.innerHTML = QUIZ_QUESTIONS.map((q, i) => `
            <div class="question" id="q${i+1}">
                <p><strong>${i + 1}. ${q.q}</strong></p>
                <div class="options">
                    ${Object.keys(q.o).map(key => `<label><input type="radio" name="q${i+1}" value="${key}"> ${key}) ${q.o[key]}</label>`).join('')}
                </div>
            </div>
        `).join('') + `<button id="btnCheckQuiz">Check Answers</button><p id="quizResult" style="font-size: 1.2em; font-weight: bold; margin-top: 15px;"></p>`;
        
        // Attach event listeners
        DOM.tabs.forEach(tab => tab.addEventListener('click', handleTabClick));
        document.getElementById('btnCheckQuiz').addEventListener('click', handleQuizCheck);
    }

    // --- 4. EVENT HANDLERS ---
    function handleTabClick(event) {
        const tabName = event.currentTarget.dataset.tab;
        DOM.tabs.forEach(tab => tab.classList.remove('active'));
        DOM.tabContents.forEach(content => content.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById(tabName).classList.add('active');
    }

    function handleQuizCheck() {
        let score = 0;
        QUIZ_QUESTIONS.forEach((q, i) => {
            const questionEl = document.getElementById(`q${i+1}`);
            questionEl.querySelectorAll('.feedback').forEach(el => el.remove());
            const selected = document.querySelector(`input[name="q${i+1}"]:checked`);
            if (selected) {
                const feedbackEl = document.createElement('span');
                feedbackEl.className = 'feedback';
                if (selected.value === q.a) {
                    feedbackEl.textContent = '‚úÖ Correct!';
                    feedbackEl.classList.add('correct');
                    score++;
                } else {
                    feedbackEl.textContent = `‚ùå Incorrect. The answer is (${q.a}).`;
                    feedbackEl.classList.add('incorrect');
                }
                selected.parentElement.appendChild(feedbackEl);
            }
        });
        document.getElementById('quizResult').textContent = `You scored ${score} out of ${QUIZ_QUESTIONS.length}.`;
    }

    init();
});
</script>

</body>
</html>